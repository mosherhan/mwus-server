<!DOCTYPE html>
<html lang="en">

<head>
    <!--
      Founders-only Project Management Dashboard
      Single file (HTML + CSS + JS). Uses Firebase (Auth + Firestore, modular v9+).

      Setup instructions:
      1) Create a Firebase project, enable Email/Password authentication, create founder accounts.
      2) Create a Firestore database (in production or test as you prefer).
      3) Replace the firebaseConfig object in the JS section with your project's values.
      4) Optionally configure Firestore Security Rules to restrict to founders.

      Collections used:
        - projects: { name, price, division, status, createdAt }
        - goals: { text, createdAt }
        - developers: { name, role, contact, createdAt }
    -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Management Â· Dashboard</title>

    <!-- Favicon and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../favicon/android-chrome-512x512.png">
    <link rel="shortcut icon" href="../favicon/favicon.ico">
    <!-- End favicon and icon block -->

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Kanban Board Styles -->
    <link rel="stylesheet" href="kanban/style.css">

    <!-- Component Styles -->
    <link rel="stylesheet" href="components/navbar.css">

    <style>
        /*
        ==========================
        Base: Aesthetic + Resets
        ==========================
      */
        :root {
            --bg: #0c0c0c;
            --panel: #121212;
            --panel-2: #141414;
            --panel-3: #151515;
            --text: #eaeaea;
            --muted: #9a9aa3;
            --accent: #a0c9ff;
            --accent-2: #b8b6ff;
            --ok: #64e0a0;
            --warn: #ffd166;
            --danger: #ff6b6b;
            --ring: rgba(160, 201, 255, 0.25);
            --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.35);
            --radius: 8px;
            --radius-sm: 12px;
            --border: #1e1e1e;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        html,
        body {
            height: 100%;
            scroll-behavior: smooth;
            scrollbar-gutter: stable;
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        /* Scrollable Content Areas */
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
            scrollbar-gutter: stable;
            scroll-behavior: smooth;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Responsive scrollable heights */
        @media (max-width: 768px) {
            .scrollable-content {
                max-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .scrollable-content {
                max-height: 250px;
            }
        }

        /* Custom Number Input Scrollbars */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Modern Number Input Spinner */
        .number-input-wrapper {
            position: relative;
        }

        .number-input-wrapper::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid var(--muted);
            pointer-events: none;
        }

        .number-input-wrapper::before {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 6px solid var(--muted);
            pointer-events: none;
            margin-top: 8px;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Heading type uses Helvetica stack */
        h1,
        h2,
        h3,
        .display {
            font-family: "Helvetica Neue", Helvetica, Arial, -apple-system, system-ui, sans-serif;
            letter-spacing: -0.01em;
        }

        h1 {
            font-size: clamp(36px, 5vw, 64px);
            line-height: 1.05;
            margin: 6px 0 18px;
            font-weight: 700;
        }

        h2 {
            font-size: 24px;
            line-height: 1.15;
            margin: 0 0 10px;
            font-weight: 700;
        }

        h3 {
            font-size: 18px;
            line-height: 1.2;
            margin: 0 0 12px;
            font-weight: 700;
        }


        a {
            color: inherit;
            text-decoration: none;
        }

        button,
        input,
        textarea,
        select {
            font: inherit;
            color: inherit;
        }

        input,
        textarea,
        select {
            background: transparent;
        }

        /*
        ==========================
        Layout: App Shell
        ==========================
      */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px 64px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 22px;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }

        .brand-badge {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: var(--panel-3);
            display: grid;
            place-items: center;
            border: 1px solid var(--border);
        }

        .brand-img {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: grid;
            place-items: center;
            background-image: url('../mwslogo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .brand-title {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .logout-btn {
            padding: 10px 14px;
            border-radius: 8px;
            background: var(--panel);
            border: 1px solid #24242a;
            transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
            cursor: pointer;
        }

        /* Light theme tokens */
        body.light {
            --bg: #fafafa;
            --panel: #ffffff;
            --panel-2: #f7f7f7;
            --panel-3: #f1f1f1;
            --text: #111111;
            --muted: #60636b;
            --accent: #4f8bff;
            --accent-2: #6a6afc;
            --ok: #2aa77b;
            --warn: #e5a93b;
            --danger: #d14d4d;
            --ring: rgba(79, 139, 255, 0.18);
            --border: #e4e4ea;
        }

        /* Analytics Premium Styling */
        .kpi-card {
            background: linear-gradient(135deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-color: var(--accent);
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card[data-metric="revenue"]:hover {
            background: linear-gradient(135deg, rgba(79, 139, 255, 0.05) 0%, rgba(106, 106, 252, 0.05) 100%);
        }

        .kpi-card[data-metric="growth"]:hover {
            background: linear-gradient(135deg, rgba(42, 167, 123, 0.05) 0%, rgba(64, 224, 160, 0.05) 100%);
        }

        .kpi-card[data-metric="projects"]:hover {
            background: linear-gradient(135deg, rgba(255, 209, 102, 0.05) 0%, rgba(255, 107, 107, 0.05) 100%);
        }

        .kpi-card[data-metric="efficiency"]:hover {
            background: linear-gradient(135deg, rgba(160, 201, 255, 0.05) 0%, rgba(184, 182, 255, 0.05) 100%);
        }

        .kpi-icon {
            font-size: 24px;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .kpi-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-change {
            font-size: 11px;
            color: var(--ok);
            font-weight: 600;
        }

        .chart-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 139, 255, 0.02) 0%, rgba(106, 106, 252, 0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .chart-card:hover::before {
            opacity: 1;
        }

        .chart-header {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .chart-container {
            position: relative;
            z-index: 1;
            height: 200px;
        }

        .analytics-summary {
            background: linear-gradient(135deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .analytics-summary:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .kpi-card {
                padding: 16px;
            }

            .kpi-value {
                font-size: 24px;
            }

            .chart-card {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Developer Income Flow Styling */
        .dev-income-item {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .dev-income-item:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dev-income-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dev-income-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .dev-income-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .dev-income-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .dev-income-label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dev-income-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .dev-income-progress {
            margin-top: 8px;
        }

        .dev-income-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--panel-3);
            border-radius: 3px;
            overflow: hidden;
        }

        .dev-income-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .dev-income-progress-text {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
            text-align: center;
        }

        /* Icon styling for theme compatibility */
        svg {
            color: currentColor;
        }

        .logout-btn svg {
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .logout-btn:hover svg {
            opacity: 1;
        }

        .btn svg {
            vertical-align: middle;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            background: #1a1a1f;
            box-shadow: var(--shadow-soft);
        }

        /*
        ==========================
        Grid: Bento Board
        ==========================
      */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 18px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: none;
            padding: 22px;
            transition: border-color .18s ease, transform .18s ease, background .2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: #2a2a2a;
        }

        .card h3 {
            margin: 2px 0 12px;
        }

        .muted {
            color: var(--muted);
        }

        /* spans across columns */
        .span-4 {
            grid-column: span 4;
        }

        .span-6 {
            grid-column: span 6;
        }

        .span-8 {
            grid-column: span 8;
        }

        .span-12 {
            grid-column: span 12;
        }

        /*
        ==========================
        Forms
        ==========================
      */
        .field {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
        }

        .input,
        .select,
        .textarea {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 12px;
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease, background .2s ease;
        }

        .textarea {
            min-height: 88px;
            resize: vertical;
        }

        .input:focus,
        .select:focus,
        .textarea:focus {
            border-color: #2f2f38;
            box-shadow: 0 0 0 6px var(--ring);
            background: #0f0f13;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            background: #181818;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            background: #1f1f1f;
        }

        .btn.primary {
            background: #1d1d1d;
            border-color: #2a2a2a;
        }

        .btn.ghost {
            background: transparent;
            border-color: #2a2a33;
        }

        .btn.danger {
            border-color: #3a2a2a;
            color: #ffb3b3;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
        }

        .col-6 {
            grid-column: span 6;
        }

        .col-4 {
            grid-column: span 4;
        }

        .col-12 {
            grid-column: span 12;
        }

        /*
        ==========================
        Lists & Cards
        ==========================
      */
        .items {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
        }

        .item {
            grid-column: span 6;
            background: #101010;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
        }

        .items {
            align-content: start;
            grid-auto-rows: auto;
        }

        .item h4 {
            margin: 4px 0 10px;
            font-size: 15px;
        }

        .status-badge {
            display: inline-grid;
            place-items: center;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            letter-spacing: .02em;
            border: 1px solid #2c2c35;
        }

        /* Responsive Grid Logic */
        @media (max-width: 768px) {
            .container {
                padding: 80px 16px 32px;
                /* increasing top padding for fixed navbar */
            }

            .row,
            .grid,
            .items {
                display: flex !important;
                flex-direction: column;
            }

            .col-6,
            .col-4,
            .col-12,
            .span-4,
            .span-6,
            .span-8,
            .span-12,
            .item {
                width: 100% !important;
                grid-column: span 12 !important;
            }

            h1 {
                font-size: 32px;
            }

            .topbar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            #nav-mount {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 4px;
            }
        }

        .ongoing {
            color: #b2f5ea;
            border-color: #254e5b;
            background: #102329;
        }

        .completed {
            color: #a0f0b5;
            border-color: #24573a;
            background: #0f2418;
        }

        .inline-input {
            width: 100%;
            background: #0e0e0e;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: 11px;
        }

        .badge.warn {
            color: #ffd6a0;
            border-color: #3a2f12;
            background: #201708;
        }

        .badge.urgent {
            color: #ffb3b3;
            border-color: #3a1e1e;
            background: #210e0e;
        }

        .progress {
            height: 24px;
            border-radius: 8px;
            background: linear-gradient(180deg, #0d0d0d, #1a1a1a);
            border: 2px solid #2a2a2a;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 14px 0 12px;
        }

        .progress>span {
            display: block;
            height: 100%;
            background: linear-gradient(135deg, #0b3d9e 0%, #0067b8 25%, #0047a0 50%, #00a3d4 75%, #46c8fa 100%);
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 0 20px rgba(116, 163, 245, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.2);
        }

        .progress>span::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.024) 30%, rgba(255, 255, 255, 0.031) 50%, rgba(255, 255, 255, 0.024) 70%, transparent 100%);
            border-radius: 14px;
            animation: progressShine 2.5s infinite;
        }

        .progress>span::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
            border-radius: 12px;
        }

        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress .progress-label {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 14px;
            color: #ffffff;
            font-weight: 800;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.5), 0 2px 6px rgba(0, 0, 0, 0.9);
            letter-spacing: 0.8px;
            z-index: 3;
            font-family: "IBM Plex Mono", ui-monospace, Menlo, Consolas, monospace;
            background: none;
            padding: 0;
            mix-blend-mode: normal;
            filter: none;
        }

        .progress .progress-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            border-radius: 6px;
            opacity: 0.4;
            z-index: 0;
        }

        .progress .progress-dots {
            position: absolute;
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
            display: flex;
            gap: 3px;
            z-index: 2;
        }

        .progress .progress-dots::before,
        .progress .progress-dots::after {
            content: '';
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: progressPulse 1.5s infinite;
        }

        .progress .progress-dots::after {
            animation-delay: 0.3s;
        }

        @keyframes progressPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        /* Modern Range Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: linear-gradient(180deg, #0a0a0a, #0f0f0f);
            height: 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(135deg, #4f8bff 0%, #7aa7ff 100%);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: 2px solid var(--panel);
            box-shadow: 0 4px 12px rgba(79, 139, 255, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(79, 139, 255, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-track {
            background: linear-gradient(180deg, #0a0a0a, #0f0f0f);
            height: 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #4f8bff 0%, #7aa7ff 100%);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: 2px solid var(--panel);
            box-shadow: 0 4px 12px rgba(79, 139, 255, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(79, 139, 255, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .select[multiple] {
            min-height: 140px;
        }

        #assignDevs {
            background: #0f0f0f;
        }

        /* Custom File Input */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }

        .file-input-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            background: #181818;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.12s ease, background 0.2s ease, border-color 0.2s ease;
            width: 100%;
            font-size: 14px;
        }

        .file-input-button:hover {
            transform: translateY(-1px);
            background: #1f1f1f;
            border-color: #2a2a2a;
        }

        .file-input-button::before {
            content: "ðŸ“Ž";
            font-size: 16px;
        }

        .file-input-button.has-file {
            background: #1d1d1d;
            border-color: #3a3a46;
            color: var(--accent);
        }

        .file-input-button.has-file::before {
            content: "âœ…";
        }

        .file-name {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            font-family: "IBM Plex Mono", ui-monospace, Menlo, Consolas, monospace;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-header {
            background: var(--panel-3);
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
        }

        .calendar-day {
            background: var(--panel);
            min-height: 40px;
            padding: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: var(--panel-2);
        }

        .calendar-day.today {
            background: var(--panel-3);
            border: 1px solid var(--accent);
        }

        .calendar-day.has-events::after {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
        }

        .calendar-day.other-month {
            color: var(--muted);
            opacity: 0.5;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .calendar-nav-btn {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--panel-2);
            transform: translateY(-1px);
        }

        .calendar-title {
            font-weight: 600;
            color: var(--text);
        }

        .event-item {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .event-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .event-time {
            color: var(--accent);
            font-weight: 500;
        }

        .event-title {
            color: var(--text);
            font-weight: 600;
            margin: 2px 0;
        }

        .event-notes {
            color: var(--muted);
            font-size: 11px;
        }

        .event-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .event-actions .btn {
            padding: 4px 8px;
            font-size: 10px;
        }

        /*
        ==========================
        Auth Views
        ==========================
      */
        .auth {
            min-height: 100vh;
            display: grid;
            place-items: center;
        }

        .auth-card {
            width: 100%;
            max-width: 380px;
            padding: 26px;
            border-radius: 8px;
            background: var(--panel);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .auth-title {
            font-weight: 700;
            margin: 6px 0 18px;
        }

        .mono {
            font-family: "IBM Plex Mono", ui-monospace, Menlo, Consolas, monospace;
        }

        /*
        ==========================
        Responsive
        ==========================
      */
        @media (max-width: 1100px) {
            .span-12 {
                grid-column: span 12;
            }

            .span-8 {
                grid-column: span 12;
            }

            .span-6 {
                grid-column: span 12;
            }

            .span-4 {
                grid-column: span 12;
            }

            .items .item {
                grid-column: span 12;
            }

            .row .col-6 {
                grid-column: span 12;
            }

            .row .col-4 {
                grid-column: span 12;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 16px 32px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .row {
                gap: 8px;
            }

            .field {
                margin-bottom: 10px;
            }

            .goals-list-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px;
            }

            .goals-list-item .goal-content {
                flex: none;
                margin-bottom: 8px;
            }

            .goals-list-item .goal-controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                align-items: center;
            }

            .goals-list-item select {
                width: 100%;
                margin-bottom: 0;
            }

            .goals-list-item .btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Mobile header fixes */
            .topbar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                padding: 16px;
            }

            .topbar .brand {
                justify-content: center;
                text-align: center;
            }

            .topbar>div:last-child {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            #globalSearch {
                width: 100% !important;
                max-width: none !important;
                margin-bottom: 8px;
            }

            /* Analytics mobile fixes */
            .analytics-summary {
                padding: 16px;
                margin-top: 16px;
            }

            #analyticsText {
                grid-template-columns: 1fr !important;
                gap: 6px;
            }

            /* Finance overview mobile fixes */
            .finance-overview-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .finance-overview-header>div:last-child {
                flex-direction: column;
                gap: 8px;
            }

            .finance-overview-header select,
            .finance-overview-header button {
                width: 100%;
            }

            /* Chart container mobile fixes */
            .chart-container {
                height: 180px;
                width: 100%;
                overflow: hidden;
            }

            /* Card header mobile fixes */
            .card>div:first-child {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .card>div:first-child>div:last-child {
                flex-direction: column;
                gap: 8px;
            }

            /* KPI grid mobile fixes */
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            .chart-card {
                min-width: 100%;
                width: 100%;
            }

            .chart-container {
                min-height: 200px;
            }

            .kpi-card {
                padding: 16px;
            }

            .kpi-value {
                font-size: 24px;
            }

            .chart-card {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px 12px 24px;
            }

            .card {
                padding: 12px;
                margin-bottom: 12px;
            }

            /* Extra small mobile header */
            .topbar {
                padding: 12px;
                gap: 8px;
            }

            .topbar .brand-title {
                font-size: 16px;
            }

            .topbar .brand span {
                font-size: 10px;
            }

            /* Single column KPI grid */
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .kpi-card {
                padding: 12px;
            }

            .kpi-value {
                font-size: 20px;
            }

            .kpi-icon {
                font-size: 20px;
                margin-bottom: 8px;
            }

            /* Chart adjustments */
            .chart-container {
                height: 160px;
            }

            .chart-card {
                padding: 16px;
            }

            /* Button adjustments */
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .logout-btn {
                padding: 8px 10px;
            }

            /* Input adjustments */
            .input,
            .select,
            .textarea {
                font-size: 14px;
                padding: 8px 10px;
            }

            /* Analytics text single column */
            #analyticsText {
                font-size: 12px;
            }

            /* Finance overview buttons stack */
            .finance-overview-header>div:last-child {
                gap: 6px;
            }

            .finance-overview-header button {
                padding: 6px 8px;
                font-size: 11px;
            }

            .finance-overview-header button svg {
                width: 10px;
                height: 10px;
            }
        }
    </style>
</head>

<body>
    <!-- ==========================
         Auth View
         ========================== -->
    <main id="auth" class="auth" aria-hidden="false">
        <section class="auth-card">
            <div class="brand" style="margin-bottom: 8px;">
                <div class="brand-img"></div>
                <div class="brand-title">Founders Â· Access</div>
            </div>
            <h2 class="auth-title">Sign in</h2>
            <div class="field">
                <label for="email">Email</label>
                <input id="email" type="email" class="input" placeholder="founder@company.com"
                    autocomplete="username" />
            </div>
            <div class="field">
                <label for="password">Password</label>
                <input id="password" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    autocomplete="current-password" />
            </div>
            <button id="loginBtn" class="btn primary" style="width: 100%; margin-top: 6px;">Sign in</button>
            <p class="muted mono" style="font-size: 12px; margin-top: 12px;">Email/password only. No signâ€‘ups here.</p>
            <p id="authError" class="mono"
                style="color: var(--danger); font-size: 12px; margin-top: 10px; display: none;"></p>
        </section>
    </main>

    <!-- ==========================
         Dashboard View
         ========================== -->
    <div id="app" class="container" style="display:none;" aria-hidden="true">
        <header class="topbar">
            <div class="brand">
                <div class="brand-img"></div>
                <div class="brand-title">Management Dashboard</div>
                <span class="muted mono" style="font-size: 12px;">internal</span>
            </div>
            <div style="display:inline-flex; align-items:center; gap:10px; flex: 1;">
                <!-- Navbar Mount Point -->
                <div id="nav-mount" style="flex:1; display:flex; justify-content:center; padding: 0 12px;"></div>

                <button id="themeToggle" class="logout-btn" title="Toggle theme">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <path
                            d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                    </svg>
                </button>
                <button id="notifBtn" class="logout-btn" title="Notifications" style="position:relative;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                    </svg>
                    <span id="notifBadge"
                        style="display:none; position:absolute; top:4px; right:4px; width:8px; height:8px; background: var(--accent); border-radius:50%;"></span>
                </button>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
        </header>

        <section style="margin: 12px 0 26px;">
            <h1 class="display" style="margin-bottom: 6px;">Founders Dashboard</h1>
            <p class="mono muted" style="max-width: 760px; font-size: 13px; line-height: 1.6;">
                MakeWithUs Founder's System (MFS) created to manage operations within MWU. System handled by Sudarsanan
                & Sherhan.
            </p>
        </section>

        <section class="grid" id="grid">
            <!-- Add Project -->
            <article class="card span-12" id="addProjectCard">
                <h3>Add Project</h3>
                <div class="row">
                    <div class="col-6 field">
                        <label for="projectName">Project Name</label>
                        <input id="projectName" class="input" placeholder="Website redesign" />
                    </div>
                    <div class="col-6 field">
                        <label for="projectPrice">Project Price (â‚¹)</label>
                        <div class="number-input-wrapper">
                            <input id="projectPrice" class="input" type="number" inputmode="decimal"
                                placeholder="20000" />
                        </div>
                    </div>
                    <div class="col-6 field">
                        <label for="status">Status</label>
                        <select id="status" class="select">
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-6 field">
                        <label for="deadline">Deadline</label>
                        <input id="deadline" class="input" type="date" />
                    </div>
                    <div class="col-6 field">
                        <label for="developerPayment">Developer Payment (â‚¹)</label>
                        <div class="number-input-wrapper">
                            <input id="developerPayment" class="input" type="number" inputmode="decimal"
                                placeholder="12000" />
                        </div>
                        <span class="muted mono" style="font-size:11px;">Payment to developers</span>
                    </div>
                    <div class="col-6 field">
                        <label for="companyPayment">Company Revenue (â‚¹)</label>
                        <div class="number-input-wrapper">
                            <input id="companyPayment" class="input" type="number" inputmode="decimal"
                                placeholder="8000" />
                        </div>
                        <span class="muted mono" style="font-size:11px;">Company profit</span>
                    </div>
                    <div class="col-12 field">
                        <label for="assignDevs">Assign Developers</label>
                        <select id="assignDevs" class="select" multiple size="4"></select>
                        <span class="muted mono" style="font-size:11px;">Hold Ctrl/Cmd to multiâ€‘select</span>
                    </div>
                    <div class="col-12 field">
                        <label for="progress">Progress</label>
                        <input id="progress" class="input" type="range" min="0" max="100" value="0" />
                    </div>
                    <div class="col-12 field">
                        <label for="projectFile">Attachment (optional)</label>
                        <div class="file-input-wrapper">
                            <input id="projectFile" type="file" />
                            <button type="button" class="file-input-button" id="projectFileBtn">Choose File</button>
                            <div class="file-name" id="projectFileName"></div>
                        </div>
                    </div>
                    <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                        <button id="addProjectBtn" class="btn primary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right:6px;">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Add Project
                        </button>
                        <span id="addProjectMsg" class="muted mono" style="font-size:12px;"></span>
                    </div>
                </div>
            </article>

            <!-- Ongoing Projects -->
            <article class="card span-12" id="projectsCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h3>Ongoing Projects</h3>
                    <span class="muted mono" id="projectsCount">0</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <input id="projectSearch" class="input"
                        placeholder="Search projects or filter by status: ongoing/completed" />
                    <button id="clearSearch" class="btn ghost">Clear</button>
                </div>
                <div class="items scrollable-content" id="projectsList"></div>
            </article>

            <!-- Developer Payouts -->
            <article class="card span-8" id="payoutsCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h3>Developer Payouts</h3>
                    <span class="muted mono" id="payoutsTotal">â‚¹0</span>
                </div>
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-6 field">
                        <label for="payoutProject">Project</label>
                        <select id="payoutProject" class="select"></select>
                    </div>
                    <div class="col-6 field">
                        <label for="payoutDeveloper">Developer</label>
                        <select id="payoutDeveloper" class="select"></select>
                    </div>
                    <div class="col-4 field">
                        <label for="payoutAmount">Amount (â‚¹)</label>
                        <input id="payoutAmount" class="input" type="number" inputmode="decimal" placeholder="10000" />
                    </div>
                    <div class="col-4 field">
                        <label for="payoutDate">Date</label>
                        <input id="payoutDate" class="input" type="date" />
                    </div>
                    <div class="col-4 field">
                        <label for="payoutNote">Note</label>
                        <input id="payoutNote" class="input" placeholder="Milestone 1" />
                    </div>
                    <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                        <button id="addPayoutBtn" class="btn">Add Payout</button>
                        <span id="addPayoutMsg" class="muted mono" style="font-size:12px;"></span>
                    </div>
                </div>
                <div id="payoutsList" class="scrollable-content"></div>
            </article>

            <!-- Client Payments -->
            <article class="card span-4" id="paymentsCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h3>Client Payments</h3>
                    <span class="muted mono" id="paymentsTotal">â‚¹0</span>
                </div>
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-12 field">
                        <label for="paymentProject">Project</label>
                        <select id="paymentProject" class="select"></select>
                    </div>
                    <div class="col-6 field">
                        <label for="paymentAmount">Amount (â‚¹)</label>
                        <input id="paymentAmount" class="input" type="number" inputmode="decimal" placeholder="25000" />
                    </div>
                    <div class="col-6 field">
                        <label for="paymentDate">Date</label>
                        <input id="paymentDate" class="input" type="date" />
                    </div>
                    <div class="col-12 field">
                        <label for="paymentNote">Note</label>
                        <input id="paymentNote" class="input" placeholder="Advance / Final / Installment" />
                    </div>
                    <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                        <button id="addPaymentBtn" class="btn">Add Payment</button>
                        <span id="addPaymentMsg" class="muted mono" style="font-size:12px;"></span>
                    </div>
                </div>
                <div id="paymentsList" class="scrollable-content"></div>
            </article>


            <!-- Resources: Invoice Templates -->
            <article class="card span-6" id="invoiceResourcesCard">
                <h3>Invoice Templates</h3>
                <p class="muted" style="font-size:13px; margin-bottom:16px;">
                    Professional billing templates for client projects.
                </p>
                <div style="display:flex; gap:12px; margin-top:auto;">
                    <a href="https://www.canva.com/design/DAGzm1zD18o/c3UBpp4Tz-_EB2kblp9-fQ/edit?utm_content=DAGzm1zD18o&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton"
                        target="_blank" class="btn primary" style="flex:1; text-decoration:none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Open Invoice Template
                    </a>
                </div>
            </article>

            <!-- Resources: Documentation Templates -->
            <article class="card span-6" id="docsResourcesCard">
                <h3>Documentation Templates</h3>
                <p class="muted" style="font-size:13px; margin-bottom:16px;">
                    Standardized guides for client onboarding and developer handoffs.
                </p>
                <div style="display:flex; gap:12px; margin-top:auto;">
                    <a href="https://www.canva.com/design/DAGxMtrI01I/RkShCfyL4pZ7aLktZ8w_YA/edit?utm_content=DAGxMtrI01I&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton"
                        target="_blank" class="btn" style="flex:1; text-decoration:none;">
                        Client Docs
                    </a>
                    <a href="https://www.canva.com/design/DAGxSd43vSk/jcKN_Mhcp6u0qGE8kdSXFQ/edit?utm_content=DAGxSd43vSk&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton"
                        target="_blank" class="btn" style="flex:1; text-decoration:none;">
                        Developer Docs
                    </a>
                </div>
            </article>

            <!-- Future Goals -->
            <article class="card span-12" id="goalsCard">
                <h3>Future Goals</h3>
                <div class="row" style="margin-bottom: 10px; align-items:end;">
                    <div class="col-6"><input id="goalText" class="input"
                            placeholder="Ship v2, automate onboarding, ..." /></div>
                    <div class="col-4" style="display:flex; gap:8px;">
                        <button id="addGoalBtn" class="btn" style="width:100%;">Add</button>
                    </div>
                </div>
                <ul id="goalsList" class="mono scrollable-content"
                    style="list-style:none; padding:0; margin:0; display:grid; gap:8px; grid-auto-rows:auto;"></ul>
            </article>

            <!-- Developers Info -->
            <article class="card span-8" id="developersCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h3>Developers</h3>
                    <span class="muted mono" id="devsCount">0</span>
                </div>
                <div class="row" style="margin-bottom: 6px;">
                    <div class="col-4 field">
                        <label for="devName">Name</label>
                        <input id="devName" class="input" placeholder="Alex Doe" />
                    </div>
                    <div class="col-4 field">
                        <label for="devRole">Role</label>
                        <input id="devRole" class="input" placeholder="Frontend Engineer" />
                    </div>
                    <div class="col-4 field">
                        <label for="devContact">Contact</label>
                        <input id="devContact" class="input" placeholder="@username | email" />
                    </div>
                    <div class="col-4 field">
                        <label for="devSkills">Skills</label>
                        <input id="devSkills" class="input" placeholder="React, Node, Design Systems" />
                    </div>
                    <div class="col-4 field">
                        <label for="devNotes">Internal Notes</label>
                        <input id="devNotes" class="input" placeholder="Strong on animations" />
                    </div>
                    <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                        <button id="addDevBtn" class="btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right:6px;">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Add Developer
                        </button>
                        <span id="addDevMsg" class="muted mono" style="font-size:12px;"></span>
                    </div>
                </div>
                <div class="items scrollable-content" id="devsList"></div>
            </article>

            <!-- Developer Income Flow -->
            <article class="card span-4" id="devIncomeCard">
                <h3>Developer Income Flow</h3>
                <div class="scrollable-content" id="devIncomeList" style="max-height:400px; display:grid; gap:12px;">
                </div>
            </article>

            <article class="card span-12" id="analyticsCard">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
                    <div>
                        <h3 style="margin:0; font-size:24px; font-weight:700;">Analytics & Insights</h3>
                        <p class="muted mono" style="font-size:12px; margin:4px 0 0;">Real-time business intelligence
                        </p>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <select id="analyticsPeriod" class="select" style="width:120px; font-size:12px;">
                            <option value="all">All Time</option>
                            <option value="year">This Year</option>
                            <option value="6months">Last 6 Months</option>
                            <option value="month">This Month</option>
                        </select>
                        <!-- Validated: analyticsView (future use) -->
                        <select id="analyticsView" class="select" style="width:100px; font-size:12px;">
                            <option value="overview">Overview</option>
                            <option value="finance">Finance</option>
                            <option value="projects">Projects</option>
                            <option value="team">Team</option>
                        </select>
                    </div>
                </div>

                <!-- KPI Metrics Row -->
                <div class="kpi-grid"
                    style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:32px;">
                    <div class="kpi-card" data-metric="revenue">
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23" />
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                            </svg>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiRevenue">â‚¹0</div>
                            <div class="kpi-label">Total Revenue</div>
                            <div class="kpi-change" id="kpiRevenueChange">+0%</div>
                        </div>
                    </div>
                    <div class="kpi-card" data-metric="growth">
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                                <polyline points="17 6 23 6 23 12" />
                            </svg>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiGrowth">0%</div>
                            <div class="kpi-label">Monthly Growth</div>
                            <div class="kpi-change" id="kpiGrowthChange">vs last month</div>
                        </div>
                    </div>
                    <div class="kpi-card" data-metric="projects">
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 3h18v18H3zM8 8h8v8H8z" />
                            </svg>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiProjects">0</div>
                            <div class="kpi-label">Active Projects</div>
                            <div class="kpi-change" id="kpiProjectsChange">0 completed</div>
                        </div>
                    </div>
                    <div class="kpi-card" data-metric="efficiency">
                        <div class="kpi-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                            </svg>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="kpiEfficiency">0%</div>
                            <div class="kpi-label">Team Efficiency</div>
                            <div class="kpi-change" id="kpiEfficiencyChange">avg completion</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid"
                    style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:24px;">

                    <!-- Revenue Trend -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 style="margin:0; font-size:16px; font-weight:600;">Revenue Trend</h4>
                            <p class="muted mono" style="font-size:11px; margin:2px 0 0;">Monthly revenue analysis</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartRevenue" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Project Performance -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 style="margin:0; font-size:16px; font-weight:600;">Project Performance</h4>
                            <p class="muted mono" style="font-size:11px; margin:2px 0 0;">Ongoing vs completed</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartProjects" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Expense Breakdown -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 style="margin:0; font-size:16px; font-weight:600;">Expense Breakdown</h4>
                            <p class="muted mono" style="font-size:11px; margin:2px 0 0;">Cost distribution analysis</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartExpenses" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Developer Productivity -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h4 style="margin:0; font-size:16px; font-weight:600;">Developer Productivity</h4>
                            <p class="muted mono" style="font-size:11px; margin:2px 0 0;">Top performers</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartProductivity" height="200"></canvas>
                        </div>
                    </div>


                    <!-- Summary Stats -->
                    <div class="analytics-summary"
                        style="margin-top:24px; padding:20px; background:var(--panel-2); border-radius:8px; border:1px solid var(--border);">
                        <div class="mono muted scrollable-content" id="analyticsText"
                            style="font-size:13px; display:grid; gap:8px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));">
                        </div>
                    </div>
            </article>


            <!-- Calendar / Meetings -->
            <article class="card span-12" id="calendarCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h3 style="margin:0; font-size:20px; font-weight:600;">Calendar & Meetings</h3>
                        <p class="muted mono" style="font-size:12px; margin:4px 0 0;">Schedule and track events</p>
                    </div>
                    <span class="muted mono" id="eventsCount">0 events</span>
                </div>

                <div class="row" style="margin-bottom: 16px;">
                    <div class="col-6">
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="prevMonth">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6" />
                                </svg>
                            </button>
                            <span class="calendar-title" id="currentMonth">January 2024</span>
                            <button class="calendar-nav-btn" id="nextMonth">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6" />
                                </svg>
                            </button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <div class="calendar-header">Sun</div>
                            <div class="calendar-header">Mon</div>
                            <div class="calendar-header">Tue</div>
                            <div class="calendar-header">Wed</div>
                            <div class="calendar-header">Thu</div>
                            <div class="calendar-header">Fri</div>
                            <div class="calendar-header">Sat</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">Add Event</h4>
                        <div class="row">
                            <div class="col-6 field">
                                <label for="eventTitle">Title</label>
                                <input id="eventTitle" class="input" placeholder="Team Meeting" />
                            </div>
                            <div class="col-6 field">
                                <label for="eventDate">Date</label>
                                <input id="eventDate" class="input" type="date" />
                            </div>
                            <div class="col-6 field">
                                <label for="eventTime">Time</label>
                                <input id="eventTime" class="input" type="time" />
                            </div>
                            <div class="col-6 field">
                                <label for="eventParticipants">Participants</label>
                                <input id="eventParticipants" class="input"
                                    placeholder="founder1@co.com, founder2@co.com" />
                            </div>
                            <div class="col-12 field">
                                <label for="eventNotes">Notes</label>
                                <textarea id="eventNotes" class="textarea"
                                    placeholder="Meeting agenda, preparation notes..." rows="3"></textarea>
                            </div>
                            <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                                <button id="addEventBtn" class="btn primary">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:6px;">
                                        <line x1="12" y1="5" x2="12" y2="19" />
                                        <line x1="5" y1="12" x2="19" y2="12" />
                                    </svg>
                                    Add Event
                                </button>
                                <span id="addEventMsg" class="muted mono" style="font-size:12px;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 16px;">
                    <h4 style="margin-bottom: 12px; font-size: 14px;">Upcoming Events</h4>
                    <div id="eventsList" class="scrollable-content"></div>
                </div>
            </article>

            <!-- Announcements -->
            <article class="card span-12" id="notesCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h3>Announcements / Notes</h3>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <input id="noteText" class="input" placeholder="Share an update for founders" />
                    <button id="addNoteBtn" class="btn">Post</button>
                </div>
                <ul id="notesList" class="mono scrollable-content"
                    style="list-style:none; padding:0; margin:0; display:grid; gap:8px;">
                </ul>
            </article>

            <!-- Tasks Management -->
            <article class="card span-12" id="tasksCard">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h3 style="margin:0; font-size:20px; font-weight:600;">Tasks</h3>
                        <p class="muted mono" style="font-size:12px; margin:4px 0 0;">Manage team tasks and assignments
                        </p>
                    </div>
                    <span class="muted mono" id="tasksCount">0 tasks</span>
                </div>
                <div class="row" style="margin-bottom: 10px;">
                    <div class="col-4 field">
                        <label for="taskTitle">Title</label>
                        <input id="taskTitle" class="input" placeholder="Design review" />
                    </div>
                    <div class="col-4 field">
                        <label for="taskAssignee">Assign to</label>
                        <select id="taskAssignee" class="select"></select>
                    </div>
                    <div class="col-2 field">
                        <label for="taskDeadline">Deadline</label>
                        <input id="taskDeadline" class="input" type="date" />
                    </div>
                    <div class="col-4 field">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="select">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="col-12 field">
                        <label for="taskDesc">Description</label>
                        <input id="taskDesc" class="input" placeholder="Short details" />
                    </div>
                    <div class="col-12" style="display:flex; gap:10px; align-items:center;">
                        <button id="addTaskBtn" class="btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right:6px;">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            Add Task
                        </button>
                        <span id="addTaskMsg" class="muted mono" style="font-size:12px;"></span>
                    </div>
                </div>
                <div id="tasksList" class="items scrollable-content"></div>
            </article>

            <!-- Kanban Board -->
            <article class="card span-12" id="kanbanContainer">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h3 style="margin:0; font-size:20px; font-weight:600;">Project Board</h3>
                        <p class="muted mono" style="font-size:12px; margin:4px 0 0;">Kanban View</p>
                    </div>
                </div>
                <!-- Root for the Kanban App -->
                <div id="kanban-root"></div>
            </article>
        </section>
    </div>

    <!-- ==========================
         External Libraries
         ========================== -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- ==========================
         Firebase + App Logic
         ========================== -->
    <script type="module">
        import { mount } from './kanban/board.js';
        import { mountNavbar } from './components/navbar.js';
        import { mountNotifications } from './components/notifications.js';
        import { renderAnalytics } from './modules/analytics.js';

        // Firebase modular SDK v9+ via CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, updateDoc, deleteDoc, doc, where } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';
        import { getDatabase, ref as dbRef, push as dbPush, onChildAdded, get } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

        // ---- Replace with your Firebase project's config ----
        const firebaseConfig = {
            apiKey: "AIzaSyC_hpImJNC4YrG3q5GhPRfRjXfYzJF-Dzk",
            authDomain: "management-8f186.firebaseapp.com",
            projectId: "management-8f186",
            storageBucket: "management-8f186.appspot.com", // corrected bucket domain
            messagingSenderId: "908972656891",
            appId: "1:908972656891:web:86910fe3fce34e91fe085e",
            measurementId: "G-9644QRM5PK"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize Kanban Board
        mount(document.getElementById('kanban-root'), {
            db, collection, onSnapshot, query, orderBy, doc, updateDoc
        });

        const storage = getStorage(app);
        const rtdb = getDatabase(app);

        // Initialize Components
        mountNavbar(document.getElementById('nav-mount'));
        mountNotifications(document.getElementById('notifBtn'), {
            db, collection, query, where, onSnapshot, orderBy, updateDoc, doc
        });

        // Custom File Input Functionality
        function setupFileInput(fileInputId, buttonId, fileNameId) {
            const fileInput = document.getElementById(fileInputId);
            const button = document.getElementById(buttonId);
            const fileName = document.getElementById(fileNameId);

            button.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    button.classList.add('has-file');
                    button.textContent = 'File Selected';
                    fileName.textContent = file.name;
                } else {
                    button.classList.remove('has-file');
                    button.textContent = 'Choose File';
                    fileName.textContent = '';
                }
            });
        }

        // Initialize file inputs when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setupFileInput('projectFile', 'projectFileBtn', 'projectFileName');
        });

        // ------------------------------
        // Calendar / Events
        // ------------------------------
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthEl = document.getElementById('currentMonth');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const eventsList = document.getElementById('eventsList');
        const eventsCount = document.getElementById('eventsCount');

        const eventTitle = document.getElementById('eventTitle');
        const eventDate = document.getElementById('eventDate');
        const eventTime = document.getElementById('eventTime');
        const eventParticipants = document.getElementById('eventParticipants');
        const eventNotes = document.getElementById('eventNotes');
        const addEventBtn = document.getElementById('addEventBtn');
        const addEventMsg = document.getElementById('addEventMsg');

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];

        function renderCalendar() {
            // Clear existing calendar days
            const existingDays = calendarGrid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            currentMonthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Render 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = dayDate.getDate();

                // Highlight today
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayEl.classList.add('today');
                }

                // Gray out other months
                if (dayDate.getMonth() !== currentMonth) {
                    dayEl.classList.add('other-month');
                }

                // Add click handler
                dayEl.addEventListener('click', () => {
                    const dateStr = dayDate.toISOString().split('T')[0];
                    eventDate.value = dateStr;
                });

                calendarGrid.appendChild(dayEl);
            }

            updateCalendarEvents();
        }

        function updateCalendarEvents() {
            // This will be called when events are loaded from Firebase
            const dayElements = calendarGrid.querySelectorAll('.calendar-day');
            dayElements.forEach(day => day.classList.remove('has-events'));

            // Add has-events class to days with events
            // This will be populated when we load events from Firebase
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        addEventBtn.addEventListener('click', async () => {
            const title = eventTitle.value.trim();
            const date = eventDate.value;
            const time = eventTime.value;
            const participants = eventParticipants.value.trim();
            const notes = eventNotes.value.trim();

            if (!title || !date) {
                flash(addEventMsg, 'Please enter title and date.', true);
                return;
            }

            try {
                await addDoc(collection(db, 'events'), {
                    title,
                    date,
                    time,
                    participants,
                    notes,
                    completed: false,
                    createdAt: serverTimestamp(),
                });

                eventTitle.value = '';
                eventDate.value = '';
                eventTime.value = '';
                eventParticipants.value = '';
                eventNotes.value = '';
                flash(addEventMsg, 'Event added.');
            } catch (e) {
                console.error('addEvent error:', e);
                flash(addEventMsg, 'Error adding event.', true);
            }
        });

        // Load events from Firebase
        onSnapshot(query(collection(db, 'events'), orderBy('date', 'asc')), (snap) => {
            eventsList.innerHTML = '';
            let count = 0;
            const today = new Date().toISOString().split('T')[0];

            snap.forEach((d) => {
                const event = { id: d.id, ...d.data() };
                count++;

                const eventEl = document.createElement('div');
                eventEl.className = `event-item ${event.completed ? 'completed' : ''}`;

                const isUpcoming = event.date >= today;
                if (!isUpcoming) return;

                eventEl.innerHTML = `
                     <div class="event-time">${event.date} ${event.time ? `at ${event.time}` : ''}</div>
                     <div class="event-title">${escapeHtml(event.title)}</div>
                     ${event.participants ? `<div class="event-notes">Participants: ${escapeHtml(event.participants)}</div>` : ''}
                     ${event.notes ? `<div class="event-notes">${escapeHtml(event.notes)}</div>` : ''}
                     <div class="event-actions">
                         <button class="btn ghost" data-action="toggle" data-id="${event.id}">
                             ${event.completed ? 'Mark Pending' : 'Mark Completed'}
                         </button>
                         <button class="btn danger" data-action="delete" data-id="${event.id}">Delete</button>
                     </div>
                 `;

                eventEl.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (!(target instanceof HTMLElement)) return;
                    const action = target.getAttribute('data-action');
                    const eventId = target.getAttribute('data-id');
                    if (!action || !eventId) return;

                    try {
                        const ref = doc(db, 'events', eventId);
                        if (action === 'toggle') {
                            await updateDoc(ref, { completed: !event.completed });
                        } else if (action === 'delete') {
                            confirmAction(`Are you sure you want to delete "${event.title}"?`, async () => {
                                try { await deleteDoc(ref); } catch (e) { console.error('delete event error:', e); }
                            });
                        }
                    } catch (e) {
                        console.error('event action error:', e);
                    }
                });

                eventsList.appendChild(eventEl);
            });

            eventsCount.textContent = String(count);
            updateCalendarEvents();
        });

        // Initialize calendar
        renderCalendar();

        // UI Elements
        const authView = document.getElementById('auth');
        const appView = document.getElementById('app');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authErrorEl = document.getElementById('authError');
        const notifBtn = document.getElementById('notifBtn');
        const notifBadge = document.getElementById('notifBadge');
        const themeToggle = document.getElementById('themeToggle');
        const globalSearch = document.getElementById('globalSearch');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // Auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authView.style.display = 'none';
                authView.setAttribute('aria-hidden', 'true');
                appView.style.display = 'block';
                appView.setAttribute('aria-hidden', 'false');
            } else {
                appView.style.display = 'none';
                appView.setAttribute('aria-hidden', 'true');
                authView.style.display = 'grid';
                authView.setAttribute('aria-hidden', 'false');
            }
        });

        loginBtn.addEventListener('click', async () => {
            const email = /** @type {HTMLInputElement} */(document.getElementById('email')).value.trim();
            const password = /** @type {HTMLInputElement} */(document.getElementById('password')).value;
            authErrorEl.style.display = 'none';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                authErrorEl.textContent = err.message ?? 'Failed to sign in';
                authErrorEl.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Theme toggle + persist
        function initTheme() { const t = localStorage.getItem('theme'); if (t === 'light') document.body.classList.add('light'); }
        initTheme();
        themeToggle?.addEventListener('click', () => { const isLight = document.body.classList.toggle('light'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); });

        // Notifications (unread badge)
        onSnapshot(query(collection(db, 'notifications'), orderBy('createdAt', 'desc')), (snap) => {
            let unread = 0; snap.forEach(d => { if (!d.data().read) unread++; });
            if (notifBadge) notifBadge.style.display = unread > 0 ? 'block' : 'none';
        });

        // ------------------------------
        // Projects
        // ------------------------------
        const projectName = document.getElementById('projectName');
        const projectPrice = document.getElementById('projectPrice');
        const status = document.getElementById('status');
        const addProjectBtn = document.getElementById('addProjectBtn');
        const addProjectMsg = document.getElementById('addProjectMsg');
        const projectsList = document.getElementById('projectsList');
        const projectsCount = document.getElementById('projectsCount');
        const assignDevs = document.getElementById('assignDevs');
        const progressInput = document.getElementById('progress');
        const deadlineInput = document.getElementById('deadline');
        const developerPaymentInput = document.getElementById('developerPayment');
        const companyPaymentInput = document.getElementById('companyPayment');
        const projectFileInput = document.getElementById('projectFile');
        const projectSearch = document.getElementById('projectSearch');
        const clearSearch = document.getElementById('clearSearch');

        // ------------------------------
        // Payouts & Payments Elements
        // ------------------------------
        const payoutProject = document.getElementById('payoutProject');
        const payoutDeveloper = document.getElementById('payoutDeveloper');
        const payoutAmount = document.getElementById('payoutAmount');
        const payoutDate = document.getElementById('payoutDate');
        const payoutNote = document.getElementById('payoutNote');
        const addPayoutBtn = document.getElementById('addPayoutBtn');
        const addPayoutMsg = document.getElementById('addPayoutMsg');
        const payoutsList = document.getElementById('payoutsList');
        const payoutsTotal = document.getElementById('payoutsTotal');

        const paymentProject = document.getElementById('paymentProject');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentDate = document.getElementById('paymentDate');
        const paymentNote = document.getElementById('paymentNote');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const addPaymentMsg = document.getElementById('addPaymentMsg');
        const paymentsList = document.getElementById('paymentsList');
        const paymentsTotal = document.getElementById('paymentsTotal');

        // Populate developer multi-select
        onSnapshot(query(collection(db, 'developers'), orderBy('createdAt', 'desc')), (snap) => {
            assignDevs.innerHTML = '';
            snap.forEach((d) => {
                const dev = { id: d.id, ...d.data() };
                const opt = document.createElement('option');
                opt.value = dev.id; opt.textContent = dev.name || 'Unnamed';
                assignDevs.appendChild(opt);
            });

            // Populate payout developer select
            payoutDeveloper.innerHTML = '';
            snap.forEach((d) => {
                const dev = { id: d.id, ...d.data() };
                const opt = document.createElement('option');
                opt.value = dev.id; opt.textContent = dev.name || 'Unnamed';
                payoutDeveloper.appendChild(opt);
            });
        });

        // ------------------------------
        // Tasks
        // ------------------------------
        const taskTitle = document.getElementById('taskTitle');
        const taskAssignee = document.getElementById('taskAssignee');
        const taskDeadline = document.getElementById('taskDeadline');
        const taskPriority = document.getElementById('taskPriority');
        const taskDesc = document.getElementById('taskDesc');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const addTaskMsg = document.getElementById('addTaskMsg');
        const tasksList = document.getElementById('tasksList');
        const tasksCount = document.getElementById('tasksCount');

        // Populate assignees
        onSnapshot(query(collection(db, 'developers'), orderBy('createdAt', 'desc')), (snap) => {
            if (!taskAssignee) return; taskAssignee.innerHTML = '';
            snap.forEach(d => { const dev = { id: d.id, ...d.data() }; const opt = document.createElement('option'); opt.value = dev.id; opt.textContent = dev.name || 'Unnamed'; taskAssignee.appendChild(opt); });
        });

        addTaskBtn?.addEventListener('click', async () => {
            const title = taskTitle?.value.trim(); if (!title) { flash(addTaskMsg, 'Enter a title', true); return; }
            try {
                await addDoc(collection(db, 'tasks'), { title, assignee: taskAssignee?.value || null, deadline: taskDeadline?.value || null, priority: taskPriority?.value || 'medium', description: taskDesc?.value.trim() || '', status: 'in_progress', progress: 0, createdAt: serverTimestamp() });
                if (taskTitle) taskTitle.value = ''; if (taskDeadline) taskDeadline.value = ''; if (taskDesc) taskDesc.value = ''; flash(addTaskMsg, 'Task added.');
            } catch (e) { console.error('addTask', e); flash(addTaskMsg, 'Error adding task', true); }
        });

        onSnapshot(query(collection(db, 'tasks'), orderBy('createdAt', 'desc')), (snap) => {
            if (!tasksList) return; tasksList.innerHTML = ''; let count = 0; snap.forEach(d => {
                count++; const t = { id: d.id, ...d.data() };
                const el = document.createElement('div'); el.className = 'item';
                el.innerHTML = `
                    <h4 class=\"mono\">${escapeHtml(t.title || '')}</h4>
                    <div class=\"mono muted\" style=\"font-size:12px; margin-bottom:6px;\">${t.deadline || ''} Â· ${t.priority || ''}</div>
                    <input class=\"inline-input\" data-k=\"description\" placeholder=\"Description\" value=\"${escapeAttr(t.description || '')}\" />
                    <div style=\"display:grid; grid-template-columns: repeat(12,1fr); gap:8px;\">
                        <select class=\"inline-input\" style=\"grid-column: span 4;\" data-k=\"status\">
                            <option value=\"in_progress\" ${t.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value=\"completed\" ${t.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <input class=\"inline-input\" style=\"grid-column: span 4;\" data-k=\"progress\" type=\"number\" min=\"0\" max=\"100\" value=\"${escapeAttr(t.progress ?? 0)}\" />
                        <input class=\"inline-input\" style=\"grid-column: span 4;\" data-k=\"deadline\" type=\"date\" value=\"${escapeAttr(t.deadline || '')}\" />
                    </div>
                    <div style=\"display:flex; gap:8px; margin-top:8px;\">
                        <button class=\"btn\" data-action=\"save\">Save</button>
                        <button class=\"btn danger\" data-action=\"delete\">Delete</button>
                    </div>
                `;
                el.addEventListener('click', async (ev) => {
                    const tgt = ev.target; if (!(tgt instanceof HTMLElement)) return; const act = tgt.getAttribute('data-action'); if (!act) return;
                    const inputs = /** @type {NodeListOf<HTMLInputElement|HTMLSelectElement>} */(el.querySelectorAll('.inline-input'));
                    const updated = {}; inputs.forEach((inp) => { const k = inp.getAttribute('data-k'); if (!k) return; updated[k] = inp.value; });
                    if (updated.progress !== undefined) updated.progress = Number(updated.progress || 0);
                    try { const ref = doc(db, 'tasks', t.id); if (act === 'save') await updateDoc(ref, updated); else if (act === 'delete') { confirmAction('Delete task?', async () => { try { await deleteDoc(ref); } catch (e) { console.error(e); } }); } } catch (e) { console.error('task action', e); }
                });
                tasksList.appendChild(el);
            });
            if (tasksCount) tasksCount.textContent = String(count);
        });

        addProjectBtn.addEventListener('click', async () => {
            const nameVal = projectName.value.trim();
            const priceVal = Number(projectPrice.value || 0);
            const statusVal = status.value;
            const deadlineVal = deadlineInput.value || null;
            const progressVal = Number(progressInput.value || 0);
            const developerPaymentVal = Number(developerPaymentInput.value || 0);
            const companyPaymentVal = Number(companyPaymentInput.value || 0);
            // Developer payment = expense, Company payment = revenue (profit)
            const expenseVal = developerPaymentVal;
            const revenueVal = companyPaymentVal;
            const profitVal = revenueVal; // Company revenue is the profit
            const assigned = Array.from(assignDevs.selectedOptions).map(o => o.value);
            if (!nameVal) { flash(addProjectMsg, 'Please enter a project name.', true); return; }
            try {
                let attachmentURL = '';
                const file = projectFileInput.files && projectFileInput.files[0];
                if (file) {
                    const sref = storageRef(storage, `projectFiles/${Date.now()}_${file.name}`);
                    await uploadBytes(sref, file);
                    attachmentURL = await getDownloadURL(sref);
                }
                await addDoc(collection(db, 'projects'), {
                    name: nameVal,
                    price: priceVal,
                    status: statusVal,
                    deadline: deadlineVal,
                    progress: progressVal,
                    developerPayment: developerPaymentVal,
                    companyPayment: companyPaymentVal,
                    expense: expenseVal,
                    revenue: revenueVal,
                    profit: profitVal,
                    assignedDevelopers: assigned,
                    attachmentURL,
                    createdAt: serverTimestamp(),
                });
                projectName.value = '';
                projectPrice.value = '';
                status.value = 'ongoing';
                deadlineInput.value = '';
                progressInput.value = '0';
                developerPaymentInput.value = '';
                companyPaymentInput.value = '';
                projectFileInput.value = '';
                document.getElementById('projectFileBtn').classList.remove('has-file');
                document.getElementById('projectFileBtn').textContent = 'Choose File';
                document.getElementById('projectFileName').textContent = '';
                flash(addProjectMsg, 'Project added.');
            } catch (e) {
                const msg = (e && e.message) ? e.message : 'Error adding project.';
                flash(addProjectMsg, msg, true);
                console.error('addProject error:', e);
            }
        });

        let latestProjects = [];
        function renderProjects(list) {
            projectsList.innerHTML = '';
            let count = 0;
            list.forEach((p) => {
                count += 1;
                const card = document.createElement('div');
                card.className = 'item';
                const overdue = p.deadline && new Date(p.deadline) < new Date() && p.status !== 'completed';
                const progress = Math.max(0, Math.min(100, Number(p.progress || 0)));
                card.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
              <h4 class="mono">${escapeHtml(p.name || '')}</h4>
              <span class="status-badge ${p.status === 'completed' ? 'completed' : 'ongoing'}">${p.status || 'ongoing'}</span>
            </div>
            <div class="mono muted" style="font-size:12px; margin-bottom:6px; display:flex; gap:8px; flex-wrap:wrap;">
              <span>â‚¹${Number(p.price || 0).toLocaleString('en-IN')}</span>
              ${p.deadline ? `<span class="badge ${overdue ? 'urgent' : ''}">Due: ${p.deadline}</span>` : ''}
              ${p.assignedDevelopers && p.assignedDevelopers.length ? `<span class="badge">Devs: ${p.assignedDevelopers.length}</span>` : ''}
              ${typeof p.profit === 'number' ? `<span class="badge ${p.profit < 0 ? 'urgent' : ''}">Profit: â‚¹${Number(p.profit || 0).toLocaleString('en-IN')}</span>` : ''}
            </div>
            <input class="inline-input" data-k="name" placeholder="Name" value="${escapeAttr(p.name || '')}" />
            <div style="display:grid; grid-template-columns: repeat(12, 1fr); gap:8px;">
              <input class="inline-input" style="grid-column: span 4;" data-k="price" type="number" inputmode="decimal" placeholder="Price" value="${escapeAttr(p.price ?? '')}" />
              <select class="inline-input" style="grid-column: span 4;" data-k="status">
                <option value="ongoing" ${p.status === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                <option value="completed" ${p.status === 'completed' ? 'selected' : ''}>Completed</option>
              </select>
              <input class="inline-input" style="grid-column: span 4;" data-k="deadline" type="date" value="${escapeAttr(p.deadline || '')}" />
              <input class="inline-input" style="grid-column: span 4;" data-k="progress" type="number" min="0" max="100" value="${escapeAttr(p.progress ?? 0)}" />
              <input class="inline-input" style="grid-column: span 4;" data-k="developerPayment" type="number" placeholder="Developer Payment (â‚¹)" value="${escapeAttr(p.developerPayment ?? p.expense ?? '')}" />
              <input class="inline-input" style="grid-column: span 4;" data-k="companyPayment" type="number" placeholder="Company Revenue (â‚¹)" value="${escapeAttr(p.companyPayment ?? p.revenue ?? '')}" />
            </div>
             <div class="progress">
                 <div class="progress-bg"></div>
                 <span style="width:${progress}%;"></span>
                 <div class="progress-dots"></div>
                 <span class="progress-label">${progress}%</span>
             </div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
              <button class="btn" data-action="save">Save</button>
              <button class="btn ghost" data-action="complete">Mark Completed</button>
              <button class="btn danger" data-action="delete">Delete</button>
              ${p.attachmentURL ? `<a class="btn ghost" href="${p.attachmentURL}" target="_blank" rel="noopener">Attachment</a>` : ''}
            </div>
          `;

                card.addEventListener('click', async (ev) => {
                    const target = ev.target;
                    if (!(target instanceof HTMLElement)) return;
                    const action = target.getAttribute('data-action');
                    if (!action) return;
                    const inputs = /** @type {NodeListOf<HTMLInputElement|HTMLSelectElement>} */(card.querySelectorAll('.inline-input'));
                    const updated = {}; inputs.forEach((el) => { const k = el.getAttribute('data-k'); if (!k) return; updated[k] = el.value; });
                    if (updated.price !== undefined) updated.price = Number(updated.price || 0);
                    ['developerPayment', 'companyPayment', 'expense', 'revenue', 'progress'].forEach(k => { if (updated[k] !== undefined) updated[k] = Number(updated[k] || 0); });
                    // Sync developerPayment/companyPayment with expense/revenue for backward compatibility
                    if (updated.developerPayment !== undefined) {
                        updated.expense = updated.developerPayment;
                    }
                    if (updated.companyPayment !== undefined) {
                        updated.revenue = updated.companyPayment;
                        updated.profit = updated.companyPayment; // Company revenue is profit
                    } else if (updated.expense !== undefined || updated.revenue !== undefined) {
                        const expenseV = updated.expense !== undefined ? updated.expense : ((p.developerPayment ?? p.expense) || 0);
                        const revenueV = updated.revenue !== undefined ? updated.revenue : ((p.companyPayment ?? p.revenue) || 0);
                        updated.profit = revenueV; // Company revenue is profit
                    }
                    const ref = doc(db, 'projects', p.id);
                    try {
                        if (action === 'save') {
                            await updateDoc(ref, updated);
                        } else if (action === 'complete') {
                            await updateDoc(ref, { status: 'completed', progress: 100 });
                        } else if (action === 'delete') {
                            confirmAction(`Are you sure you want to delete "${p.name}"? This action cannot be undone.`, async () => {
                                try { await deleteDoc(ref); } catch (e) { console.error('delete project error:', e); }
                            });
                        }
                    } catch (e) { console.error('project action error:', e); }
                });

                projectsList.appendChild(card);
            });
            projectsCount.textContent = String(count);
            updateAnalytics(list);
            refreshCharts(); // Update charts when projects change
        }

        onSnapshot(query(collection(db, 'projects'), orderBy('createdAt', 'desc')), (snap) => {
            projectsList.innerHTML = '';
            latestProjects = [];
            snap.forEach((docSnap) => { latestProjects.push({ id: docSnap.id, ...docSnap.data() }); });
            renderProjects(latestProjects);

            // Populate project selects for payouts/payments
            payoutProject.innerHTML = '';
            paymentProject.innerHTML = '';
            latestProjects.forEach(p => {
                const opt1 = document.createElement('option'); opt1.value = p.id; opt1.textContent = p.name || 'Untitled';
                const opt2 = document.createElement('option'); opt2.value = p.id; opt2.textContent = p.name || 'Untitled';
                payoutProject.appendChild(opt1); paymentProject.appendChild(opt2);
            });
            // trigger refresh lists
            refreshPayouts();
            refreshPayments();
            refreshCharts();
            captureFinanceFromSnapshots();
        });

        // Search/filter
        projectSearch.addEventListener('input', () => {
            const q = projectSearch.value.trim().toLowerCase();
            if (!q) return renderProjects(latestProjects);
            const filtered = latestProjects.filter(p => {
                return (p.name || '').toLowerCase().includes(q) || (p.status || '').toLowerCase().includes(q);
            });
            renderProjects(filtered);
        });
        clearSearch.addEventListener('click', () => {
            confirmAction('Clear search and show all projects?', () => {
                projectSearch.value = '';
                renderProjects(latestProjects);
            });
        });

        // Global search (projects + developers + tasks basic)
        function performGlobalSearch(q) {
            q = (q || '').trim().toLowerCase(); if (!q) { renderProjects(latestProjects); return; }
            const filtered = latestProjects.filter(p => (p.name || '').toLowerCase().includes(q) || (p.status || '').toLowerCase().includes(q));
            renderProjects(filtered);
        }
        globalSearch?.addEventListener('input', () => performGlobalSearch(globalSearch.value));

        // Analytics filters
        const analyticsPeriod = document.getElementById('analyticsPeriod');
        const analyticsView = document.getElementById('analyticsView');

        analyticsPeriod?.addEventListener('change', () => {
            refreshCharts();
        });

        analyticsView?.addEventListener('change', () => {
            refreshCharts();
        });

        // Developer Income Flow - Wired to Developer Payments
        const devIncomeList = document.getElementById('devIncomeList');

        function renderDeveloperIncome() {
            if (!devIncomeList) return;

            // Aggregate developer payments from all project payouts
            const devPaymentsMap = new Map();

            // Get all projects and their payouts
            latestProjects.forEach(project => {
                onSnapshot(query(collection(db, `projects/${project.id}/payouts`), orderBy('date', 'desc')), (snap) => {
                    snap.forEach((docSnap) => {
                        const payout = { id: docSnap.id, ...docSnap.data() };
                        const devId = payout.developerId;
                        const devName = payout.developerName || 'Unknown Developer';
                        const amount = Number(payout.amount || 0);

                        if (!devPaymentsMap.has(devId)) {
                            devPaymentsMap.set(devId, {
                                id: devId,
                                name: devName,
                                totalPaid: 0,
                                totalEarned: 0
                            });
                        }

                        const devData = devPaymentsMap.get(devId);
                        devData.totalPaid += amount;
                    });

                    // Also calculate total earned from project developer payments
                    latestProjects.forEach(p => {
                        const devPayment = Number((p.developerPayment ?? p.expense) || 0);
                        if (p.assignedDevelopers && p.assignedDevelopers.length > 0) {
                            const perDevPayment = devPayment / p.assignedDevelopers.length;
                            p.assignedDevelopers.forEach(devId => {
                                if (!devPaymentsMap.has(devId)) {
                                    const dev = latestDevelopers.find(d => d.id === devId);
                                    devPaymentsMap.set(devId, {
                                        id: devId,
                                        name: dev?.name || 'Unknown Developer',
                                        totalPaid: 0,
                                        totalEarned: 0
                                    });
                                }
                                devPaymentsMap.get(devId).totalEarned += perDevPayment;
                            });
                        }
                    });

                    updateDevIncomeDisplay(Array.from(devPaymentsMap.values()));
                });
            });

            // Also listen to project changes to recalculate
            if (latestProjects.length > 0) {
                updateDevIncomeFromProjects();
            }
        }

        function updateDevIncomeFromProjects() {
            if (!devIncomeList) return;

            const devPaymentsMap = new Map();

            // Calculate total earned from project developer payments
            latestProjects.forEach(p => {
                const devPayment = Number((p.developerPayment ?? p.expense) || 0);
                if (p.assignedDevelopers && p.assignedDevelopers.length > 0) {
                    const perDevPayment = devPayment / p.assignedDevelopers.length;
                    p.assignedDevelopers.forEach(devId => {
                        if (!devPaymentsMap.has(devId)) {
                            const dev = latestDevelopers.find(d => d.id === devId);
                            devPaymentsMap.set(devId, {
                                id: devId,
                                name: (dev?.name) || 'Unknown Developer',
                                totalPaid: 0,
                                totalEarned: perDevPayment
                            });
                        } else {
                            devPaymentsMap.get(devId).totalEarned += perDevPayment;
                        }
                    });
                }
            });

            // Get paid amounts from payouts
            latestProjects.forEach(project => {
                onSnapshot(query(collection(db, `projects/${project.id}/payouts`), orderBy('date', 'desc')), (snap) => {
                    snap.forEach((docSnap) => {
                        const payout = { id: docSnap.id, ...docSnap.data() };
                        const devId = payout.developerId;
                        const amount = Number(payout.amount || 0);

                        if (!devPaymentsMap.has(devId)) {
                            const dev = latestDevelopers.find(d => d.id === devId);
                            devPaymentsMap.set(devId, {
                                id: devId,
                                name: (dev?.name) || (payout.developerName) || 'Unknown Developer',
                                totalPaid: amount,
                                totalEarned: 0
                            });
                        } else {
                            devPaymentsMap.get(devId).totalPaid += amount;
                        }
                    });

                    updateDevIncomeDisplay(Array.from(devPaymentsMap.values()));
                }, { onlyOnce: true });
            });

            if (devPaymentsMap.size === 0) {
                updateDevIncomeDisplay([]);
            }
        }

        function updateDevIncomeDisplay(devPayments) {
            if (!devIncomeList) return;

            if (devPayments.length === 0) {
                devIncomeList.innerHTML = '<div class="muted mono" style="text-align:center; padding:20px; font-size:12px;">No developer payments recorded</div>';
                return;
            }

            devIncomeList.innerHTML = devPayments.map(dev => {
                const totalEarned = Number(dev.totalEarned || 0);
                const totalPaid = Number(dev.totalPaid || 0);
                const pendingAmount = totalEarned - totalPaid;
                const progressPercent = totalEarned > 0 ? (totalPaid / totalEarned * 100) : 0;

                return `
                    <div class="dev-income-item">
                        <div class="dev-income-header">
                            <div class="dev-income-name">${escapeHtml(dev.name || 'Unknown Developer')}</div>
                        </div>
                        <div class="dev-income-amounts">
                            <div class="dev-income-stat">
                                <div class="dev-income-label">Total Earned</div>
                                <div class="dev-income-value">â‚¹${totalEarned.toLocaleString('en-IN')}</div>
                            </div>
                            <div class="dev-income-stat">
                                <div class="dev-income-label">Amount Paid</div>
                                <div class="dev-income-value">â‚¹${totalPaid.toLocaleString('en-IN')}</div>
                            </div>
                            <div class="dev-income-stat">
                                <div class="dev-income-label">Pending</div>
                                <div class="dev-income-value">â‚¹${pendingAmount.toLocaleString('en-IN')}</div>
                            </div>
                            <div class="dev-income-stat">
                                <div class="dev-income-label">Progress</div>
                                <div class="dev-income-value">${progressPercent.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="dev-income-progress">
                            <div class="dev-income-progress-bar">
                                <div class="dev-income-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                            </div>
                            <div class="dev-income-progress-text">Payment Progress</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize developer income flow
        renderDeveloperIncome();
        const goalText = document.getElementById('goalText');
        const addGoalBtn = document.getElementById('addGoalBtn');
        const goalsList = document.getElementById('goalsList');
        // extend goals with status + priority
        const GOAL_STATUSES = ['pending', 'in_progress', 'achieved'];

        addGoalBtn.addEventListener('click', async () => {
            const text = goalText.value.trim();
            if (!text) return;
            try {
                await addDoc(collection(db, 'goals'), { text, status: 'pending', priority: 2, createdAt: serverTimestamp() });
                goalText.value = '';
            } catch (e) { console.error('addGoal error:', e); }
        });

        onSnapshot(query(collection(db, 'goals'), orderBy('createdAt', 'desc')), (snap) => {
            goalsList.innerHTML = '';
            snap.forEach((d) => {
                const g = { id: d.id, ...d.data() };
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.gap = '10px';
                li.style.background = '#0e0e12';
                li.style.border = '1px solid #202028';
                li.style.borderRadius = '12px';
                li.style.padding = '10px 12px';
                li.innerHTML = `
                     <div class="goal-content" style="flex:1; margin-bottom: 8px;">${escapeHtml(g.text || '')}</div>
                     <div class="goal-controls" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                         <select class="inline-input" style="width:140px;" data-k="status">
                             ${GOAL_STATUSES.map(s => `<option value="${s}" ${g.status === s ? 'selected' : ''}>${s.replace('_', ' ')}</option>`).join('')}
                         </select>
                         <select class="inline-input" style="width:120px;" data-k="priority">
                             <option value="1" ${String(g.priority) === '1' ? 'selected' : ''}>Low</option>
                             <option value="2" ${String(g.priority) === '2' ? 'selected' : ''}>Medium</option>
                             <option value="3" ${String(g.priority) === '3' ? 'selected' : ''}>High</option>
                         </select>
                         <button class="btn ghost" data-action="save">Save</button>
                         <button class="btn ghost" data-action="delete">Delete</button>
                     </div>
                 `;
                li.addEventListener('click', async (ev) => {
                    const t = ev.target; if (!(t instanceof HTMLElement)) return;
                    const action = t.getAttribute('data-action');
                    if (!action) return;
                    const statusEl = /** @type {HTMLSelectElement} */(li.querySelector('[data-k="status"]'));
                    const prioEl = /** @type {HTMLSelectElement} */(li.querySelector('[data-k="priority"]'));
                    try {
                        if (action === 'save') await updateDoc(doc(db, 'goals', g.id), { status: statusEl.value, priority: Number(prioEl.value) });
                        else if (action === 'delete') {
                            confirmAction(`Are you sure you want to delete this goal?`, async () => {
                                try { await deleteDoc(doc(db, 'goals', g.id)); } catch (e) { console.error('delete goal error:', e); }
                            });
                        }
                    } catch (e) { console.error('goal action error:', e); }
                });
                goalsList.appendChild(li);
            });
        });

        // ------------------------------
        // Developers
        // ------------------------------
        const devName = document.getElementById('devName');
        const devRole = document.getElementById('devRole');
        const devContact = document.getElementById('devContact');
        const devSkills = document.getElementById('devSkills');
        const devNotes = document.getElementById('devNotes');
        const addDevBtn = document.getElementById('addDevBtn');
        const devsList = document.getElementById('devsList');
        const devsCount = document.getElementById('devsCount');
        const addDevMsg = document.getElementById('addDevMsg');

        addDevBtn.addEventListener('click', async () => {
            const name = devName.value.trim();
            const role = devRole.value.trim();
            const contact = devContact.value.trim();
            const skills = devSkills.value.trim();
            const notes = devNotes.value.trim();
            if (!name) { flash(addDevMsg, 'Enter a name', true); return; }
            try {
                await addDoc(collection(db, 'developers'), { name, role, contact, skills, notes, createdAt: serverTimestamp() });
                devName.value = ''; devRole.value = ''; devContact.value = ''; devSkills.value = ''; devNotes.value = '';
                flash(addDevMsg, 'Developer added.');
            } catch (e) { console.error('addDeveloper error:', e); flash(addDevMsg, e && e.message ? e.message : 'Error adding developer', true); }
        });

        let latestDevelopers = [];
        let developersMap = {}; // Map ID -> Developer Object

        function updateDeveloperDropdowns() {
            // Update Payout Developer Dropdown
            const payoutSelect = document.getElementById('payoutDeveloper');
            if (payoutSelect) {
                const currentVal = payoutSelect.value;
                payoutSelect.innerHTML = '<option value="" disabled selected>Select Developer</option>';
                latestDevelopers.forEach(dev => {
                    const opt = document.createElement('option');
                    opt.value = dev.id;
                    opt.textContent = dev.name;
                    payoutSelect.appendChild(opt);
                });
                if (currentVal) payoutSelect.value = currentVal;
            }
        }

        onSnapshot(query(collection(db, 'developers'), orderBy('createdAt', 'desc')), (snap) => {
            devsList.innerHTML = '';
            latestDevelopers = [];
            developersMap = {};
            let count = 0;
            snap.forEach((d) => {
                count += 1;
                const dev = { id: d.id, ...d.data() };
                latestDevelopers.push(dev);
                developersMap[dev.id] = dev;

                const c = document.createElement('div');
                c.className = 'item';
                c.innerHTML = `
            <h4 class="mono">${escapeHtml(dev.name || '')}</h4>
            <input class="inline-input" data-k="name" placeholder="Name" value="${escapeAttr(dev.name || '')}" />
            <div style="display:grid; grid-template-columns: repeat(12, 1fr); gap:8px;">
              <input class="inline-input" style="grid-column: span 6;" data-k="role" placeholder="Role" value="${escapeAttr(dev.role || '')}" />
              <input class="inline-input" style="grid-column: span 6;" data-k="contact" placeholder="Contact" value="${escapeAttr(dev.contact || '')}" />
            </div>
            <input class="inline-input" data-k="skills" placeholder="Skills" value="${escapeAttr(dev.skills || '')}" />
            <input class="inline-input" data-k="notes" placeholder="Notes" value="${escapeAttr(dev.notes || '')}" />
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button class="btn" data-action="save">Save</button>
              <button class="btn danger" data-action="delete">Delete</button>
            </div>
          `;
                c.addEventListener('click', async (ev) => {
                    const t = ev.target; if (!(t instanceof HTMLElement)) return;
                    const action = t.getAttribute('data-action'); if (!action) return;
                    const inputs = /** @type {NodeListOf<HTMLInputElement>} */(c.querySelectorAll('.inline-input'));
                    const updated = {}; inputs.forEach((el) => { const k = el.getAttribute('data-k'); if (!k) return; updated[k] = el.value; });
                    try {
                        const ref = doc(db, 'developers', dev.id);
                        if (action === 'save') await updateDoc(ref, updated);
                        else if (action === 'delete') {
                            confirmAction(`Are you sure you want to delete developer "${dev.name}"? This action cannot be undone.`, async () => {
                                try { await deleteDoc(ref); } catch (e) { console.error('delete developer error:', e); }
                            });
                        }
                    } catch (e) { console.error('developer action error:', e); }
                });
                devsList.appendChild(c);
            });
            devsCount.textContent = String(count);
            updateDeveloperDropdowns();
            // Update developer income flow when developers change
            if (devIncomeList) updateDevIncomeFromProjects();
            refreshCharts(); // Refresh charts to update names if needed
        });

        // ------------------------------
        // Utilities
        // ------------------------------
        function flash(el, text, isError = false) {
            el.textContent = text; el.style.color = isError ? 'var(--danger)' : 'var(--muted)';
            el.style.opacity = '1';
            setTimeout(() => { el.style.transition = 'opacity .6s ease'; el.style.opacity = '0'; }, 1400);
        }

        function confirmAction(message, action) {
            if (confirm(message)) {
                action();
            }
        }

        function escapeHtml(str) {
            return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
        }
        function escapeAttr(str) {
            return String(str).replaceAll('&', '&amp;').replaceAll('"', '&quot;');
        }

        // Simple analytics text block
        const analyticsText = document.getElementById('analyticsText');
        function updateAnalytics(list) {
            if (!analyticsText) return;
            const total = list.length;
            const completed = list.filter(p => p.status === 'completed').length;
            const ongoing = total - completed;
            const totalDeveloperPayment = list.reduce((s, p) => s + Number((p.developerPayment ?? p.expense) || 0), 0);
            const totalCompanyPayment = list.reduce((s, p) => s + Number((p.companyPayment ?? p.revenue) || 0), 0);
            const totalExpense = totalDeveloperPayment;
            const totalRevenue = totalCompanyPayment;
            const totalProfit = totalRevenue; // Company revenue is profit
            analyticsText.innerHTML = `
          <span>Projects: ${total} (Ongoing: ${ongoing}, Completed: ${completed})</span>
          <span>Developer Payments: â‚¹${totalDeveloperPayment.toLocaleString('en-IN')}</span>
          <span>Company Revenue: â‚¹${totalCompanyPayment.toLocaleString('en-IN')}</span>
          <span>Total Project Value: â‚¹${(totalDeveloperPayment + totalCompanyPayment).toLocaleString('en-IN')}</span>
          <span>Profit: â‚¹${totalProfit.toLocaleString('en-IN')}</span>
        `;
        }

        // Charts (Chart.js) - Premium Analytics
        // Refactored to module
        function refreshCharts() {
            if (!latestProjects) return;
            // Get contexts from DOM
            const ctxR = document.getElementById('chartRevenue')?.getContext('2d');
            const ctxP = document.getElementById('chartProjects')?.getContext('2d');
            const ctxE = document.getElementById('chartExpenses')?.getContext('2d');
            const ctxProd = document.getElementById('chartProductivity')?.getContext('2d');

            const timeFilter = document.getElementById('analyticsPeriod')?.value || 'all';
            renderAnalytics({ ctxR, ctxP, ctxE, ctxProd }, latestProjects, { timeFilter, developersMap });
        }

        document.getElementById('analyticsPeriod')?.addEventListener('change', refreshCharts);


        // Notes / announcements
        const noteText = document.getElementById('noteText');
        const notesList = document.getElementById('notesList');
        addNoteBtn?.addEventListener('click', async () => {
            const text = noteText.value.trim(); if (!text) return;
            try { await addDoc(collection(db, 'notes'), { text, createdAt: serverTimestamp() }); noteText.value = ''; } catch (e) { console.error('addNote error:', e); }
        });
        onSnapshot(query(collection(db, 'notes'), orderBy('createdAt', 'desc')), (snap) => {
            notesList.innerHTML = '';
            snap.forEach(d => {
                const n = { id: d.id, ...d.data() };
                const li = document.createElement('li');
                li.style.display = 'flex'; li.style.gap = '10px'; li.style.alignItems = 'center';
                li.style.border = '1px solid #202028'; li.style.background = '#0e0e12'; li.style.borderRadius = '12px'; li.style.padding = '10px 12px';
                li.innerHTML = `<span style="flex:1;">${escapeHtml(n.text || '')}</span><button class="btn ghost" data-action="delete">Delete</button>`;
                li.addEventListener('click', async (ev) => {
                    const t = ev.target;
                    if (!(t instanceof HTMLElement)) return;
                    if (t.getAttribute('data-action') === 'delete') {
                        confirmAction('Are you sure you want to delete this note?', async () => {
                            try { await deleteDoc(doc(db, 'notes', n.id)); } catch (e) { console.error('deleteNote error:', e); }
                        });
                    }
                });
                notesList.appendChild(li);
            });
        });

        // ------------------------------
        // Chat (Realtime Database)
        // ------------------------------
        const chatRef = dbRef(rtdb, 'chat');

        // Load existing messages on page load
        // Load existing messages on page load
        function loadExistingMessages() {
            if (!chatMessages) return;
            chatMessages.innerHTML = '';
            get(chatRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    const messageArray = Object.values(messages).sort((a, b) => (a.ts || 0) - (b.ts || 0));
                    messageArray.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'event-item';
                        const time = new Date(m.ts || Date.now()).toLocaleString('en-IN');
                        div.innerHTML = `<div class="event-time">${escapeHtml(m.user || '')}</div><div class="event-title">${escapeHtml(m.text || '')}</div><div class="event-notes">${time}</div>`;
                        chatMessages.appendChild(div);
                    });
                    // REMOVED AUTO SCROLL ON LOAD to prevent page jumping
                    // chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }).catch(e => console.error('load messages error:', e));
        }

        // Load existing messages
        // Load messages via onChildAdded (handles both existing and new)
        let initialLoadParams = true;
        onChildAdded(chatRef, (snap) => {
            if (!chatMessages) return;
            const m = snap.val();
            // dedupe if needed, but simplistic approach first
            const div = document.createElement('div');
            div.className = 'event-item';
            const time = new Date(m.ts || Date.now()).toLocaleString('en-IN');
            div.innerHTML = `<div class="event-time">${escapeHtml(m.user || '')}</div><div class="event-title">${escapeHtml(m.text || '')}</div><div class="event-notes">${time}</div>`;
            chatMessages.appendChild(div);

            // Only scroll if it's a NEW message interacting with the user, OR if user was already at bottom. 
            // For now, easier to just NOT scroll on initial load batch.
            // Check if document is ready.
            if (!initialLoadParams) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });

        // Give a small buffer for initial data load before enabling auto-scroll
        setTimeout(() => { initialLoadParams = false; }, 2000);

        sendChatBtn?.addEventListener('click', async () => {
            const text = chatInput?.value.trim(); if (!text) return; const user = auth.currentUser?.email || 'anon';
            try { await dbPush(chatRef, { text, user, ts: Date.now() }); if (chatInput) chatInput.value = ''; } catch (e) { console.error('chat send', e); }
        });

        // ------------------------------
        // Finance Overview (filters + export)
        // ------------------------------
        const financeHistory = document.getElementById('financeHistory');
        const financeFilterMonth = document.getElementById('financeFilterMonth');
        const financeFilterCategory = document.getElementById('financeFilterCategory');
        const exportCSV = document.getElementById('exportCSV');
        const exportPDF = document.getElementById('exportPDF');

        function monthOptions() { const now = new Date(); const opts = []; for (let i = 0; i < 12; i++) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; const label = d.toLocaleString('en-IN', { month: 'long', year: 'numeric' }); opts.push({ key, label }); } return opts; }
        if (financeFilterMonth) { monthOptions().forEach(o => { const opt = document.createElement('option'); opt.value = o.key; opt.textContent = o.label; financeFilterMonth.appendChild(opt); }); }

        let financeRecords = [];
        function renderFinance() { if (!financeHistory) return; financeHistory.innerHTML = ''; const m = financeFilterMonth?.value; const cat = financeFilterCategory?.value || 'all'; const list = financeRecords.filter(r => (m ? (r.month === m) : true) && (cat === 'all' || r.category === cat)); list.forEach(r => { const div = document.createElement('div'); div.className = 'event-item'; div.innerHTML = `<div class="event-time">${r.date}</div><div class="event-title">â‚¹${Number(r.amount).toLocaleString('en-IN')} Â· ${r.category}</div><div class="event-notes">${escapeHtml(r.note || '')}</div>`; financeHistory.appendChild(div); }); }
        financeFilterMonth?.addEventListener('change', renderFinance); financeFilterCategory?.addEventListener('change', renderFinance);

        function captureFinanceFromSnapshots() {
            financeRecords = [];
            // Fetch finance data from projects
            if (latestProjects && latestProjects.length > 0) {
                latestProjects.forEach(project => {
                    if (project.revenue && project.revenue > 0) {
                        financeRecords.push({
                            date: project.createdAt?.toDate?.()?.toLocaleDateString('en-IN') || new Date().toLocaleDateString('en-IN'),
                            amount: project.revenue,
                            category: 'income',
                            note: `Revenue from ${project.name}`,
                            month: project.createdAt?.toDate?.() ? `${project.createdAt.toDate().getFullYear()}-${String(project.createdAt.toDate().getMonth() + 1).padStart(2, '0')}` : ''
                        });
                    }
                    if (project.expense && project.expense > 0) {
                        financeRecords.push({
                            date: project.createdAt?.toDate?.()?.toLocaleDateString('en-IN') || new Date().toLocaleDateString('en-IN'),
                            amount: project.expense,
                            category: 'expense',
                            note: `Expense for ${project.name}`,
                            month: project.createdAt?.toDate?.() ? `${project.createdAt.toDate().getFullYear()}-${String(project.createdAt.toDate().getMonth() + 1).padStart(2, '0')}` : ''
                        });
                    }
                });
            }
            renderFinance();
        }

        exportCSV?.addEventListener('click', () => {
            const rows = [['Date', 'Amount', 'Category', 'Note']].concat(financeRecords.map(r => [r.date, r.amount, r.category, r.note || '']));
            const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"', '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'finance.csv'; a.click();
        });
        exportPDF?.addEventListener('click', () => {
            if (!window.jspdf) return; const { jsPDF } = window.jspdf; const docPdf = new jsPDF();
            docPdf.text('Finance Overview', 14, 16);
            financeRecords.slice(0, 30).forEach((r, i) => { docPdf.text(`${r.date}  â‚¹${Number(r.amount).toLocaleString('en-IN')}  ${r.category}  ${r.note || ''}`, 14, 26 + i * 6); });
            docPdf.save('finance.pdf');
        });

        // ------------------------------
        // Payouts & Payments Logic
        // ------------------------------
        function formatINR(n) { return `â‚¹${Number(n || 0).toLocaleString('en-IN')}`; }

        payoutProject?.addEventListener('change', refreshPayouts);
        paymentProject?.addEventListener('change', refreshPayments);

        async function refreshPayouts() {
            payoutsList.innerHTML = '';
            payoutsTotal.textContent = 'â‚¹0';
            const pid = payoutProject.value; if (!pid) return;
            onSnapshot(query(collection(db, `projects/${pid}/payouts`), orderBy('date', 'desc')), (snap) => {
                let total = 0; payoutsList.innerHTML = '';
                snap.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    total += Number(p.amount || 0);
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.innerHTML = `
                        <div class="event-time">${p.date || ''}</div>
                        <div class="event-title">${formatINR(p.amount)}</div>
                        ${p.developerName ? `<div class="event-notes">${p.developerName}</div>` : ''}
                        ${p.note ? `<div class="event-notes">${p.note}</div>` : ''}
                        <div class="event-actions">
                            <button class="btn danger" data-action="delete" data-id="${p.id}">Delete</button>
                        </div>
                    `;
                    item.addEventListener('click', async (ev) => {
                        const t = ev.target; if (!(t instanceof HTMLElement)) return;
                        if (t.getAttribute('data-action') === 'delete') {
                            confirmAction(`Are you sure you want to delete this payout of ${formatINR(p.amount)}?`, async () => {
                                try { await deleteDoc(doc(db, `projects/${pid}/payouts`, p.id)); } catch (e) { console.error('delete payout', e); }
                            });
                        }
                    });
                    payoutsList.appendChild(item);
                });
                payoutsTotal.textContent = formatINR(total);
            });
        }

        async function refreshPayments() {
            paymentsList.innerHTML = '';
            paymentsTotal.textContent = 'â‚¹0';
            const pid = paymentProject.value; if (!pid) return;
            onSnapshot(query(collection(db, `projects/${pid}/payments`), orderBy('date', 'desc')), (snap) => {
                let total = 0; paymentsList.innerHTML = '';
                snap.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    total += Number(p.amount || 0);
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.innerHTML = `
                        <div class="event-time">${p.date || ''}</div>
                        <div class="event-title">${formatINR(p.amount)}</div>
                        ${p.note ? `<div class="event-notes">${p.note}</div>` : ''}
                        <div class="event-actions">
                            <button class="btn danger" data-action="delete" data-id="${p.id}">Delete</button>
                        </div>
                    `;
                    item.addEventListener('click', async (ev) => {
                        const t = ev.target; if (!(t instanceof HTMLElement)) return;
                        if (t.getAttribute('data-action') === 'delete') {
                            confirmAction(`Are you sure you want to delete this payment of ${formatINR(p.amount)}?`, async () => {
                                try { await deleteDoc(doc(db, `projects/${pid}/payments`, p.id)); } catch (e) { console.error('delete payment', e); }
                            });
                        }
                    });
                    paymentsList.appendChild(item);
                });
                paymentsTotal.textContent = formatINR(total);
            });
        }

        addPayoutBtn?.addEventListener('click', async () => {
            const pid = payoutProject.value;
            const did = payoutDeveloper.value;
            const amount = Number(payoutAmount.value || 0);
            const date = payoutDate.value || null;
            const note = payoutNote.value.trim();
            if (!pid || !did || !amount) { flash(addPayoutMsg, 'Select project/developer and amount', true); return; }
            const devOption = payoutDeveloper.options[payoutDeveloper.selectedIndex];
            const developerName = devOption ? devOption.textContent : '';
            try {
                await addDoc(collection(db, `projects/${pid}/payouts`), { developerId: did, developerName, amount, date, note, createdAt: serverTimestamp() });
                payoutAmount.value = ''; payoutDate.value = ''; payoutNote.value = '';
                flash(addPayoutMsg, 'Payout added.');
            } catch (e) { console.error('addPayout error', e); flash(addPayoutMsg, 'Error adding payout', true); }
        });

        addPaymentBtn?.addEventListener('click', async () => {
            const pid = paymentProject.value;
            const amount = Number(paymentAmount.value || 0);
            const date = paymentDate.value || null;
            const note = paymentNote.value.trim();
            if (!pid || !amount) { flash(addPaymentMsg, 'Select project and amount', true); return; }
            try {
                await addDoc(collection(db, `projects/${pid}/payments`), { amount, date, note, createdAt: serverTimestamp() });
                paymentAmount.value = ''; paymentDate.value = ''; paymentNote.value = '';
                flash(addPaymentMsg, 'Payment added.');
            } catch (e) { console.error('addPayment error', e); flash(addPaymentMsg, 'Error adding payment', true); }
        });
    </script>
</body>

</html>